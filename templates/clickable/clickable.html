<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <title>Graphs</title>
    <!-- <link rel="stylesheet" href="style.css"> -->
</head>

<body>
    <h1>Semester Offered</h1>
    <div id="chartContainer"></div>
    <div id="chartContainer1"></div>
    <script src="http://d3js.org/d3.v3.js"></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
    <script src="https://cdn.rawgit.com/novus/nvd3/v1.8.1/build/nv.d3.min.js"></script>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.1.15-beta/nv.d3.min.css' rel='stylesheet'>

    <script>
        //Data from database         
        var serialized = {% autoescape off %} 
                           {{serialized}} 
                        {% endautoescape %}

        console.log(serialized)


        var margin = {
                top: 30,
                right: 20,
                bottom: 70,
                left: 50
            },
            width = 1200 - margin.left - margin.right,
            height = 800 - margin.top - margin.bottom;

        // Set the ranges
        // var x = d3.time.scale().range([0, width]);
        var x = d3.scale.ordinal().rangeRoundBands([30, width - 40], .1)
        var y = d3.scale.linear().range([height, 0]);

        // Define the axes
        var xAxis = d3.svg.axis().scale(x)
            .orient("bottom").ticks(5);

        var yAxis = d3.svg.axis().scale(y)
            .orient("left").ticks(5);

        //declare our new arrayâ€™s name will be data and we initiate the nest function;
        var sum_courses = d3.nest()
            .key(function(d) {
                return d.Semester;
            })
            .key(function(d) {
                return d.Class;
            }) //assign the key for our new array as Title
            //add all same titles in a semseter
            .rollup(function(d) {
                return {
                    "Act_enrol": d3.sum(d, function(g) {
                        return g.Act_enrol;
                    })
                };
            })
            .entries(serialized);

        console.log(sum_courses)
        console.log("Sum Course has what I want. How do access that?")


        var data_values = d3.values(sum_courses).map(function(d, i) {
            return d.values
        })
        console.log(data_values)
        var class_name = data_values.map(function(d) {
            return d.map(function(g) {
                return g.key
            })
        })
        console.log(class_name)

        var dd = data_values.map(function(d) {
            return d.map(function(g) {
                return g.values
            })
        })
        console.log(dd.map(function(d) {
            return d.map(function(g) {
                return g.Act_enrol
            })
        }))


        // console.log(d3.map( data_values ).entries())

        console.log(data_values.length)

        console.log(d3.max(data_values, function(d) {
            return d3.max(d, function(v) {
                return v.values
            })
        }))

        // console.log(d3.max( data_values, function(d) { 
        //         return d3.max( d, function(v) { return v.values } ) } ))

        // console.log(d3.values(data_values).map(function(d){return d.map(function(v,i){return d.values})}))

        // var class_values = JSON.stringify(d3.values(data_values).map(function(d){return d.map(function(v,i){return v})}))
        // console.log(class_values)

        var class_values1 = d3.values(data_values).map(function(d) {
                return d.map(function(v, i) {
                    return v
                })
            })
            // console.log(class_values1)
            // console.log(d3.values(class_values).map(function(d){return d.keys}))
        d3.values(data_values).map(function(d) {
            return d.map(function(v, i) {
                return d.values
            })
        })
        d3.values(data_values).map(function(d) {
            return d.map(function(v, i) {
                return d.values
            })
        })
        var sem_act_enrol = d3.values(data_values).map(function(d) {
            return d.map(function(obj) {
                var rObj = {};
                rObj["values"] = (obj.values);
                rObj["keys"] = (obj.key);
                return rObj;
            })
        })

        console.log(d3.entries(sem_act_enrol))


        //set canvas size 
        var width = 1400,
            height = 900;
        var svgcanvas = d3.select("#chartContainer")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g");
        //set up axis
        var x = d3.scale.ordinal()
            .rangeRoundBands([30, width - 400], .1)
            .domain(serialized.map(function(d) {
                return d.Semester;
            }));

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom")
            .ticks(20)
            .outerTickSize(1);

        var y = d3.scale.linear()
            .range([height - 150, 0])
            .nice()
            .domain([0, d3.max(serialized, function(d) {
                return parseInt(d['Act_enrol'])
            })]);


        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left")
            .ticks(16)
            .outerTickSize(1);

        var tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        var tip = d3.tip()
            .attr('class', 'd3-tip')
            .offset([-10, 0])
            .html(function(d) {
                return "<strong>" + d.Class + ":</strong> <span style='color:red'>" + d.Act_enrol + "</span>";
            })

        // don't want dots overlapping axis, so add in buffer to data domain

        x.domain(serialized.map(function(d) {
            return d.Semester;
        }));

        y.domain([0, d3.max(serialized, function(d) {
            return +(d['Act_enrol'])
        }) + 1]);
        //set color scale
        var cValue = function(d) {
                return d.Class;
            },
            color = d3.scale.category20();

        //drawing the axis
        var y_x_axis = height - 150;
        d3.select("svg").append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0, " + y_x_axis + " )")
            .call(xAxis)
            .selectAll("text")
            .style("text-anchor", "end")
            .style("font-size", "13px")
            .attr("dx", "-.8em") //relative coordinates (relative to the specified x and y)
            .attr("dy", "-1.00em")
            .attr("transform", function(d) {
                return "rotate(-80)"
            });
        svgcanvas.call(tip);

        d3.select("svg").append("g")
            .attr("class", "y axis")
            .attr("transform", "translate(30,0)")
            .call(yAxis)
            .append("text")
            .attr("class", "label")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Number of Students");

        //addint title
        svgcanvas.append("text")
            .attr("x", (width / 2))
            .attr("y", 0 + 15)
            .attr("class", "title")
            .attr("text-anchor", "middle")
            .style("font-size", "16px")
            .style("text-decoration", "underline")
            .text("Computer Science Classes");

        // draw dots
        var dots = svgcanvas.selectAll(".dot")
            .data(serialized)
            .enter().append("circle")
            .attr("class", "dot")
            .attr("id", function(d) {
                return d.Class;
            })
            .attr("r", 3)
            // .attr("cx", 200)
            .attr("cx", function(d) {
                return x(d.Semester);
            })
            // )
            .attr("cy", function(d) {
                return y(d.Act_enrol);
            })
            .style("fill", function(d) {
                return color(cValue(d));
            })
            .on('mouseover', tip.show)
            .on('mouseout', tip.hide)


        var colors = d3.scale.category20();



        var legend = svgcanvas.selectAll(".legend")
            .data(color.domain())
            .enter().append("g")
            .attr("class", "legend")
            .attr("transform", function(d, i) {
                return "translate(0," + i * 19 + ")";
            });

        // draw legend colored rectangles
        legend.append("rect")
            .attr("x", width - 20)
            .attr("width", 18)
            .attr("height", 18)
            .style("fill", color);

        // draw legend text
        legend.append("text")
            .attr("x", width - 40)
            .attr("y", 9)
            .attr("dy", ".35em")
            .style("text-anchor", "end")
            .text(function(d) {
                return d;
            })

        



    </script>
</body>

</html>